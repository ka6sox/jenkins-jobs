[ -f Makefile ] && echo "Makefile exists (ok)" || wget http://shr.bearstech.com/Makefile

sed -i 's#BRANCH_COMMON = .*#BRANCH_COMMON = jansa/test-all#g' Makefile

make update-common

echo "UPDATE_CONFFILES_ENABLED = 1" > config.mk
echo "RESET_ENABLED = 1" >> config.mk

###########################

[ -d shr-core ] && echo "shr-core already checked out (ok)" || make setup-shr-core 2>&1
make update-conffiles 2>&1

cp common/conf/local.conf shr-core/conf/local.conf
sed -i 's/#PARALLEL_MAKE.*/PARALLEL_MAKE = "-j 8"/'          shr-core/conf/local.conf
sed -i 's/#BB_NUMBER_THREADS.*/BB_NUMBER_THREADS = "5"/' shr-core/conf/local.conf
sed -i 's/# INHERIT += "rm_work"/INHERIT += "rm_work"/'      shr-core/conf/local.conf

# Reminder to change it later when we have public instance
sed -i 's/PRSERV_HOST = "localhost:0"/PRSERV_HOST = "localhost:0"/' shr-core/conf/local.conf

echo 'BB_GENERATE_MIRROR_TARBALLS = "1"'                  >> shr-core/conf/local.conf

############################

if [ ! -d shr-core/buildhistory/ ] ; then
  cd shr-core/
  git clone git+ssh://git@git.shr-project.org/buildhistory.git
  cd buildhistory;
  git checkout -b jenkins-oe-shr-core-branches origin/jenkins-oe-shr-core-branches || git checkout -b jenkins-oe-shr-core-branches
  cd ../..
fi

echo 'BUILDHISTORY_DIR = "${TOPDIR}/buildhistory"'                           >> shr-core/conf/local.conf
echo 'BUILDHISTORY_COMMIT ?= "1"'                                            >> shr-core/conf/local.conf
echo 'BUILDHISTORY_COMMIT_AUTHOR ?= "Martin Jansa <Martin.Jansa@gmail.com>"' >> shr-core/conf/local.conf
echo 'BUILDHISTORY_PUSH_REPO ?= "origin jenkins-oe-shr-core-branches"'          >> shr-core/conf/local.conf

###############################


sed 's/^DISTRO/#DISTRO/g' -i shr-core/setup-local

echo 'require world_fixes.inc' >> shr-core/conf/local.conf
cat > shr-core/conf/world_fixes.inc << EOF
PREFERRED_PROVIDER_udev = "systemd"
PREFERRED_VERSION_gupnp = "0.19.3"
PREFERRED_VERSION_gssdp = "0.13.2"
PREFERRED_VERSION_gupnp-av = "0.11.6"

# use gold
DISTRO_FEATURES_append = " ld-is-gold"

# use systemd
DISTRO_FEATURES_append = " systemd"
DISTRO_FEATURES_BACKFILL_CONSIDERED = "sysvinit"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = ""

# use opengl
DISTRO_FEATURES_append = " opengl"

PREFERRED_PROVIDER_jpeg = "libjpeg-turbo"
PREFERRED_PROVIDER_jpeg-native = "libjpeg-turbo-native"
PREFERRED_PROVIDER_gpsd = "gpsd"
PREFERRED_PROVIDER_e-wm-sysactions = "e-wm"
ESYSACTIONS = "e-wm-sysactions"

# don't pull libhybris unless explicitly asked for
PREFERRED_PROVIDER_virtual/libgl ?= "mesa"
PREFERRED_PROVIDER_virtual/libgles1 ?= "mesa"
PREFERRED_PROVIDER_virtual/libgles2 ?= "mesa"
PREFERRED_PROVIDER_virtual/egl ?= "mesa"

# to fix fsoaudiod, alsa-state conflict in shr-image-all
VIRTUAL-RUNTIME_alsa-state = "fsoaudiod"
# to fix apm, fso-apm conflict in shr-image-all
VIRTUAL-RUNTIME_apm = "fso-apm"

require conf/distro/include/qt5-versions.inc

# for qtwebkit etc
# see https://bugzilla.yoctoproject.org/show_bug.cgi?id=5013
# DEPENDS_append_pn-qtbase = " mesa"
PACKAGECONFIG_append_pn-qtbase = " icu gl accessibility"

inherit blacklist
# PNBLACKLIST[samsung-rfs-mgr] = "needs newer libsamsung-ipc with negative D_P: Requested 'samsung-ipc-1.0 >= 0.2' but version of libsamsung-ipc is 0.1.0"
PNBLACKLIST[android-system] = "depends on lxc from meta-virtualiazation which isn't included in my world builds"
PNBLACKLIST[bigbuckbunny-1080p] = "big and doesn't really need to be tested so much"
PNBLACKLIST[bigbuckbunny-480p] = "big and doesn't really need to be tested so much"
PNBLACKLIST[bigbuckbunny-720p] = "big and doesn't really need to be tested so much"
PNBLACKLIST[bigbuckbunny-720p] = "big and doesn't really need to be tested so much"
PNBLACKLIST[tearsofsteel-1080p] = "big and doesn't really need to be tested so much"


###########################

# echo 'require world_mask.inc' >> shr-core/conf/local.conf
cat > shr-core/conf/world_mask.inc << EOF


# after moving to nonworking
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-multimedia/libdc1394/libdc1394_git.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-support/atk/at-spi2-core_2.6.3.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-qt/qt-apps/qmmp_0.6.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-qt/qcanobserver/qcanobserver_svn.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-graphics/waffle/waffle_1.2.2.bb, do_patch
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-core/images/world-image.bb, do_populate_lic
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/epiphany/epiphany_2.30.6.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-kernel/compat-wireless/compat-wireless-all_3.6.8.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-core/images/world-image.bb, do_rootfs
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/zenity/zenity_2.32.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-mediacentre/xbmc/xbmc_git.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-multimedia/gstreamer/gst123_0.3.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-dvb/wscan/wscan_20121111.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/gnome-power-manager/gnome-power-manager_2.32.0.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-devtools/geany/geany_1.22.bb, do_configure

# before moving to nonworking
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-qt/qwt/qwt-e_6.0.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-multimedia/libdc1394/libdc1394_git.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-qt/qt-apps/qmmp_0.6.1.bb, do_compile
#  virtual:native:/home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-devtools/nodejs/nodejs_0.6.20.bb, do_populate_sysroot
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-qt/qcanobserver/qcanobserver_svn.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-support/atk/at-spi2-core_2.6.3.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-devtools/nodejs/nodejs_0.6.20.bb, do_install
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-graphics/waffle/waffle_1.2.2.bb, do_patch
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-core/images/world-image.bb, do_populate_lic
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-core/images/world-image.bb, do_rootfs
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/epiphany/epiphany_2.30.6.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-kernel/compat-wireless/compat-wireless-all_3.6.8.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-graphics/slim/slim_1.3.2.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-graphics/fbida/fbida_2.08.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/system-tools/system-tools-backends_2.10.2.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-support/syslog-ng/syslog-ng_3.2.5.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-smartphone/meta-samsung/recipes-bsp/samsung-modem-mgr/samsung-modem-mgr_git.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/zenity/zenity_2.32.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-mediacentre/xbmc/xbmc_git.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-multimedia/gstreamer/gst123_0.3.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-dvb/wscan/wscan_20121111.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/gnome/gnome-terminal_2.26.3.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-support/fftw/benchfft_3.1.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/gnome-power-manager/gnome-power-manager_2.32.0.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-devtools/geany/geany_1.22.bb, do_configure

# 20130313:
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/libgnome/libgnome_2.32.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/libgnome/libgnomecanvas_2.26.0.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-qt/fingerterm/fingerterm_1.0.2.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-qt/qcanobserver/qcanobserver_svn.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-kernel/compat-wireless/compat-wireless-all_3.6.8.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-core/images/world-image.bb, do_populate_lic
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-core/images/world-image.bb, do_rootfs
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-multimedia/minidlna/minidlna_1.0.25.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/gcalctool/gcalctool_5.32.0.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-multimedia/v4l2apps/media-ctl_git.bb, do_configure
#  /home/jenkins/oe/shr-core-branches/shr-core/openembedded-core/meta/recipes-devtools/qemu/qemu_1.4.0.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-support/gperftools/gperftools_2.0.bb, do_install
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/zenity/zenity_2.32.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-mediacentre/xbmc/xbmc_git.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-multimedia/recipes-multimedia/gstreamer/gst123_0.3.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-oe/recipes-devtools/tclap/tclap_1.2.1.bb, do_install
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-networking/recipes-protocols/xl2tpd/xl2tpd_1.3.1.bb, do_compile
#  /home/jenkins/oe/shr-core-branches/shr-core/meta-openembedded/meta-gnome/recipes-gnome/gnome-power-manager/gnome-power-manager_2.32.0.bb, do_compile
########### fails to build for long time

###### oe-core
# fails to build target version
# EXCLUDE_FROM_WORLD_pn-qemu = "1"

###### meta-oe
# missing depends
EXCLUDE_FROM_WORLD_pn-minidlna = "1"

